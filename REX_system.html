<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REX_System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- PDF.js pour les aperçus -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuration du Worker PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* BASE & TYPOGRAPHIE */
        :root { --bg: #000000; --fg: #e5e5e5; --border: #222; }
        body {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            background-color: var(--bg);
            color: var(--fg);
            margin: 0; 
            overflow: hidden;
            letter-spacing: -0.02em;
            -webkit-font-smoothing: antialiased;
        }
        
        /* UI ELEMENTS */
        .glass { background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .btn-hover { transition: all 0.2s; }
        .btn-hover:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border: 2px solid var(--bg); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .dropdown { animation: slide 0.1s ease-out forwards; transform-origin: top right; }
        @keyframes slide { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        input::placeholder { color: #444; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen bg-black"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SYSTEME D'ICON ---
        const Icon = ({ p, size = 16, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {p}
            </svg>
        );
        const Paths = {
            Folder: <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>,
            Sort: <><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            Check: <polyline points="20 6 9 17 4 12"/>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            Left: <polyline points="15 18 9 12 15 6"/>,
            Right: <polyline points="9 18 15 12 9 6"/>,
            Terminal: <><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></>,
            Play: <polygon points="5 3 19 12 5 21 5 3"/>,
            FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>
        };

        // --- COMPOSANT THUMBNAIL PDF ---
        const PdfThumbnail = ({ url }) => {
            const canvasRef = useRef(null);
            const [loaded, setLoaded] = useState(false);
            const [error, setError] = useState(false);

            useEffect(() => {
                let active = true;
                const render = async () => {
                    try {
                        const loadingTask = pdfjsLib.getDocument(url);
                        const pdf = await loadingTask.promise;
                        if (!active) return;
                        const page = await pdf.getPage(1);
                        if (!active) return;

                        const viewport = page.getViewport({ scale: 1 });
                        // Calcul d'échelle pour fitter dans ~180px
                        const scale = 180 / viewport.width;
                        const scaledViewport = page.getViewport({ scale });

                        const canvas = canvasRef.current;
                        if (!canvas) return;

                        canvas.height = scaledViewport.height;
                        canvas.width = scaledViewport.width;

                        const renderContext = {
                            canvasContext: canvas.getContext('2d'),
                            viewport: scaledViewport
                        };
                        await page.render(renderContext).promise;
                        if (active) setLoaded(true);
                    } catch (e) {
                        console.error("PDF Render Error", e);
                        if (active) setError(true);
                    }
                };
                render();
                return () => { active = false; };
            }, [url]);

            if (error) return <div className="text-red-500 text-[10px] font-bold border border-red-900 px-2 py-1 rounded">PDF ERROR</div>;

            return (
                <div className="w-full h-full flex items-center justify-center bg-[#111] relative overflow-hidden">
                    {!loaded && <span className="text-gray-600 text-[10px] animate-pulse">LOADING PDF...</span>}
                    <canvas ref={canvasRef} className={`max-w-full max-h-full object-contain transition-opacity duration-500 ${loaded ? 'opacity-100' : 'opacity-0'}`} />
                </div>
            );
        };

        // --- GRILLE VIRTUELLE ---
        const VirtualGrid = ({ files, onSelect }) => {
            const [scrollTop, setScrollTop] = useState(0);
            const containerRef = useRef(null);
            const [dims, setDims] = useState({ w: 0, h: 0 });

            useEffect(() => {
                if (!containerRef.current) return;
                const observer = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        setDims({ w: entry.contentRect.width, h: entry.contentRect.height });
                    }
                });
                observer.observe(containerRef.current);
                return () => observer.disconnect();
            }, []);

            const itemSize = 180;
            const gap = 1; 
            const colCount = Math.floor(dims.w / (itemSize + gap)) || 1;
            const rowHeight = itemSize + gap;
            const totalRows = Math.ceil(files.length / colCount);
            
            const visibleRows = Math.ceil(dims.h / rowHeight) + 2;
            const startRow = Math.floor(scrollTop / rowHeight);
            const endRow = Math.min(totalRows, startRow + visibleRows);

            const items = [];
            for (let r = startRow; r < endRow; r++) {
                for (let c = 0; c < colCount; c++) {
                    const i = r * colCount + c;
                    if (i < files.length) {
                        const f = files[i];
                        items.push(
                            <div key={f.id} onClick={() => onSelect(i)} 
                                style={{ position: 'absolute', top: r * rowHeight, left: c * (itemSize + gap) + gap, width: itemSize, height: itemSize }}
                                className="group cursor-pointer bg-[#050505] border border-[#222] hover:border-white transition-colors overflow-hidden"
                            >
                                {f.type.startsWith('image/') ? (
                                    <img 
                                        src={f.url} 
                                        loading="lazy" 
                                        decoding="async" 
                                        className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" 
                                    />
                                ) : f.type === 'application/pdf' ? (
                                    // Utilisation du composant de prévisualisation PDF
                                    <PdfThumbnail url={f.url} />
                                ) : (
                                    <div className="w-full h-full relative flex items-center justify-center">
                                        <video src={f.url} preload="metadata" className="absolute inset-0 w-full h-full object-cover opacity-60" />
                                        <div className="z-10 bg-white text-black p-2 rounded-full"><Icon p={Paths.Play} size={16} fill="black" /></div>
                                        <span className="absolute top-1 left-1 text-[9px] font-bold bg-white text-black px-1">MOV</span>
                                    </div>
                                )}
                                <div className="absolute bottom-0 w-full bg-black/90 border-t border-white py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                    <p className="text-[9px] text-white truncate font-mono uppercase">{f.name}</p>
                                </div>
                            </div>
                        );
                    }
                }
            }

            return (
                <div 
                    className="flex-1 overflow-y-auto relative bg-black w-full h-full" 
                    ref={containerRef} 
                    onScroll={e => setScrollTop(e.target.scrollTop)}
                >
                    <div style={{ height: totalRows * rowHeight, width: '100%' }}>{items}</div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [files, setFiles] = useState([]);
            const [meta, setMeta] = useState({ name: null, count: 0 });
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [ui, setUi] = useState({ filter: 'all', sort: 'name', order: 'asc', search: '', menu: false });

            // Import Logic
            const handleImport = useCallback((e) => {
                const raw = Array.from(e.target.files);
                if (!raw.length) return;

                files.forEach(f => URL.revokeObjectURL(f.url));

                const path = raw[0].webkitRelativePath;
                const folder = path ? path.split('/')[0] : "ROOT";

                const processed = raw
                    .filter(f => !f.name.startsWith('.'))
                    .map((f, i) => {
                        let type = f.type;
                        if (f.name.toLowerCase().endsWith('.pdf')) type = 'application/pdf';
                        else if (f.name.toLowerCase().endsWith('.mkv')) type = 'video/x-matroska';
                        else if (!type) type = 'application/octet-stream';

                        return {
                            id: i,
                            name: f.name,
                            type: type,
                            url: URL.createObjectURL(f),
                            size: f.size,
                            date: f.lastModified
                        };
                    });
                
                setFiles(processed);
                setMeta({ name: folder, count: processed.length });
            }, [files]);

            const displayFiles = useMemo(() => {
                let res = files;
                if (ui.search) res = res.filter(f => f.name.toLowerCase().includes(ui.search.toLowerCase()));
                if (ui.filter !== 'all') {
                    if (ui.filter === 'doc') res = res.filter(f => f.type === 'application/pdf');
                    else res = res.filter(f => f.type.startsWith(ui.filter === 'image' ? 'image/' : 'video/'));
                }
                
                return [...res].sort((a, b) => {
                    let vA, vB;
                    if (ui.sort === 'name') return ui.order === 'asc' ? a.name.localeCompare(b.name, undefined, {numeric: true}) : b.name.localeCompare(a.name, undefined, {numeric: true});
                    if (ui.sort === 'date') { vA = a.date; vB = b.date; }
                    else { vA = a.size; vB = b.size; }
                    return ui.order === 'asc' ? vA - vB : vB - vA;
                });
            }, [files, ui]);

            const stats = useMemo(() => ({
                img: files.filter(f => f.type.startsWith('image/')).length,
                vid: files.filter(f => f.type.startsWith('video/')).length,
                doc: files.filter(f => f.type === 'application/pdf').length
            }), [files]);

            const toggleSort = (field) => setUi(p => ({ ...p, sort: field, order: (p.sort === field && p.order === 'asc') ? 'desc' : 'asc', menu: false }));

            return (
                <div className="flex flex-col h-full w-full bg-black text-gray-300 font-mono text-xs select-none" onClick={() => setUi(p => ({...p, menu: false}))}>
                    
                    {/* HEADER */}
                    <header className="glass h-12 shrink-0 flex items-center justify-between px-4 z-30 relative">
                        <div className="flex items-center gap-3 w-1/3 min-w-fit">
                            <Icon p={Paths.Terminal} className="text-white" />
                            <h1 className="text-white font-bold tracking-widest uppercase truncate max-w-[200px]">
                                {meta.name ? `/${meta.name}` : "/SYSTEM_READY"}
                            </h1>
                        </div>

                        <div className="flex-1 max-w-md mx-4 relative group">
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600"><Icon p={Paths.Search} size={14} /></span>
                            <input 
                                type="text" 
                                placeholder="SEARCH..." 
                                value={ui.search}
                                onChange={e => setUi(p => ({...p, search: e.target.value}))}
                                className="w-full bg-black border border-[#333] focus:border-white py-1.5 pl-9 pr-2 text-white outline-none placeholder-gray-700 uppercase transition-colors"
                            />
                        </div>

                        <div className="flex items-center justify-end gap-3 w-1/3 min-w-fit">
                            {files.length > 0 && (
                                <div className="relative">
                                    <button onClick={(e) => { e.stopPropagation(); setUi(p => ({...p, menu: !p.menu})); }} className="btn-hover border border-[#333] px-3 py-1 flex items-center gap-2 uppercase font-bold text-gray-400 whitespace-nowrap">
                                        <Icon p={Paths.Sort} size={14} /> {ui.sort}
                                    </button>
                                    {ui.menu && (
                                        <div className="absolute right-0 top-8 w-32 bg-black border border-white z-50 dropdown p-1 shadow-xl">
                                            {['name', 'date', 'size'].map(k => (
                                                <button key={k} onClick={() => toggleSort(k)} className="w-full flex justify-between px-2 py-2 text-gray-400 hover:bg-white hover:text-black uppercase border-b border-[#222] last:border-0">
                                                    {k} {ui.sort === k && <Icon p={Paths.Check} size={12} />}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            <label className="cursor-pointer bg-white text-black hover:bg-gray-300 px-4 py-1.5 font-bold uppercase border border-white transition flex items-center gap-2 whitespace-nowrap">
                                <span>LOAD_DIR</span>
                                <input type="file" webkitdirectory="" directory="" multiple className="hidden" onChange={handleImport} />
                            </label>
                        </div>
                    </header>

                    {/* STATUS BAR */}
                    {files.length > 0 && (
                        <div className="h-8 shrink-0 flex items-center justify-between px-4 border-b border-[#222] bg-[#050505] z-20">
                            <div className="flex gap-4 text-[10px] text-gray-500 uppercase">
                                <span>Total: <b className="text-white">{meta.count}</b></span>
                                <span>Img: <b className="text-white">{stats.img}</b></span>
                                <span>Vid: <b className="text-white">{stats.vid}</b></span>
                                <span>Doc: <b className="text-white">{stats.doc}</b></span>
                            </div>
                            <div className="flex gap-1">
                                {['all', 'image', 'video', 'doc'].map(f => (
                                    <button key={f} onClick={() => setUi(p => ({...p, filter: f}))} className={`px-2 py-0.5 border uppercase text-[10px] ${ui.filter === f ? 'border-white text-white' : 'border-transparent text-gray-600 hover:text-gray-400'}`}>
                                        {f}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* GRID */}
                    <main className="flex-1 flex flex-col bg-black relative overflow-hidden">
                        {!files.length ? (
                            <div className="flex-1 flex flex-col items-center justify-center opacity-30">
                                <Icon p={Paths.Terminal} size={32} />
                                <p className="mt-2 font-mono">WAITING FOR INPUT...</p>
                            </div>
                        ) : !displayFiles.length ? (
                            <div className="flex-1 flex items-center justify-center text-gray-600">NO MATCH</div>
                        ) : (
                            <VirtualGrid files={displayFiles} onSelect={setSelectedIdx} />
                        )}
                    </main>

                    {/* LIGHTBOX */}
                    {selectedIdx !== null && displayFiles[selectedIdx] && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col fade-in">
                            <div className="h-10 flex justify-between items-center px-4 border-b border-[#222] bg-black">
                                <span className="text-gray-500">IDX: <span className="text-white">{selectedIdx + 1}</span>/{displayFiles.length}</span>
                                <button onClick={() => setSelectedIdx(null)} className="text-white hover:text-red-500"><Icon p={Paths.X} /></button>
                            </div>
                            
                            <div className="flex-1 flex items-center justify-center p-4 bg-[#050505]" onClick={() => setSelectedIdx(null)}>
                                <div className="relative w-full h-full flex items-center justify-center" onClick={e => e.stopPropagation()}>
                                    {displayFiles[selectedIdx].type.startsWith('image/') ? (
                                        <img src={displayFiles[selectedIdx].url} className="max-w-full max-h-full border border-[#222] object-contain" />
                                    ) : displayFiles[selectedIdx].type === 'application/pdf' ? (
                                        <iframe src={displayFiles[selectedIdx].url} className="w-[85%] h-full border border-[#222] bg-white" title="PDF Reader"></iframe>
                                    ) : (
                                        <video src={displayFiles[selectedIdx].url} controls autoPlay className="max-w-full max-h-full border border-[#222]" />
                                    )}
                                </div>
                            </div>

                            <div className="h-10 border-t border-[#222] bg-black flex items-center justify-center gap-4 uppercase text-[10px] text-gray-500">
                                <span>FILE: <b className="text-white">{displayFiles[selectedIdx].name}</b></span>
                                <span>|</span>
                                <span>SIZE: <b className="text-white">{(displayFiles[selectedIdx].size / 1024 / 1024).toFixed(2)} MB</b></span>
                            </div>

                            <button onClick={(e) => { e.stopPropagation(); if(selectedIdx > 0) setSelectedIdx(selectedIdx - 1); }} className="absolute left-4 top-1/2 p-4 text-[#444] hover:text-white"><Icon p={Paths.Left} size={24} /></button>
                            <button onClick={(e) => { e.stopPropagation(); if(selectedIdx < displayFiles.length - 1) setSelectedIdx(selectedIdx + 1); }} className="absolute right-4 top-1/2 p-4 text-[#444] hover:text-white"><Icon p={Paths.Right} size={24} /></button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
